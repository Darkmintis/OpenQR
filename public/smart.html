<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Redirect | OpenQR</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f9fafb;
            color: #111827;
        }
        .container {
            max-width: 500px;
            width: 90%;
            margin: 40px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 24px;
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
            color: #111827;
        }
        .icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon svg {
            width: 30px;
            height: 30px;
            fill: none;
            stroke: white;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .footer {
            text-align: center;
            margin-top: 32px;
            font-size: 14px;
            color: #6b7280;
        }
        .footer a {
            color: #4f46e5;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .spinner {
            border: 4px solid rgba(79, 70, 229, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            text-align: center;
            margin: 20px 0;
        }
        .dark-mode {
            background-color: #111827;
            color: #f9fafb;
        }
        .dark-mode .container {
            background-color: #1f2937;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
        }
        .dark-mode h1 {
            color: #f9fafb;
        }
        .dark-mode .footer {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon" id="icon">
            <!-- Icon will be replaced based on condition type -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <h1>Smart QR Redirect</h1>
        <div class="spinner" id="spinner"></div>
        <p id="message">Checking conditions...</p>
        <div class="footer">
            Powered by <a href="/openqr/" target="_blank">OpenQR</a> |
            <a href="https://github.com/Darkmintis/OpenQR" target="_blank">GitHub</a> |
            <a href="https://github.com/sponsors/Darkmintis" target="_blank">Support Us</a>
        </div>
    </div>

    <script>
        // Icons for different condition types
        const icons = {
            time: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
            location: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
            language: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 5h12M2 10h12M2 15h12M2 20h12M19 5V2.5a.5.5 0 0 1 1 0V5h1.5a.5.5 0 0 1 0 1H20v1.5a.5.5 0 0 1-1 0V6h-1.5a.5.5 0 0 1 0-1H19zM16 12h6m-3-3v6"></path></svg>`,
            darkMode: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`
        };

        // Function to check if string is valid URL
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (error) {
                console.debug('Invalid URL:', error);
                return false;
            }
        }

        // Function to process time-based condition
        function processTimeCondition(conditions, defaultUrl) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinute;
            
            const [startHour, startMinute] = conditions.startTime.split(':').map(Number);
            const [endHour, endMinute] = conditions.endTime.split(':').map(Number);
            
            const startTime = startHour * 60 + startMinute;
            const endTime = endHour * 60 + endMinute;
            
            if (currentTime >= startTime && currentTime <= endTime) {
                document.getElementById('message').textContent = 'Within business hours. Redirecting...';
                return conditions.redirectUrl || defaultUrl;
            }
            document.getElementById('message').textContent = 'Outside business hours. Redirecting...';
            return defaultUrl;
        }

        // Function to process location-based condition
        function processLocationCondition(conditions, defaultUrl) {
            const userLanguage = navigator.language || navigator.userLanguage;
            const userCountry = userLanguage.split('-')[1] || 'US';
            
            if (conditions.countries.includes(userCountry)) {
                document.getElementById('message').textContent = `Location matched (${userCountry}). Redirecting...`;
                return conditions.redirectUrl || defaultUrl;
            }
            document.getElementById('message').textContent = `Location not matched (${userCountry}). Using default. Redirecting...`;
            return defaultUrl;
        }

        // Function to process language-based condition
        function processLanguageCondition(conditions, defaultUrl) {
            const userLang = navigator.language.split('-')[0] || 'en';
            
            if (conditions.languages.includes(userLang) && conditions.redirectUrls[userLang]) {
                document.getElementById('message').textContent = `Language matched (${userLang}). Redirecting...`;
                return conditions.redirectUrls[userLang];
            }
            document.getElementById('message').textContent = `Language not matched (${userLang}). Using default. Redirecting...`;
            return defaultUrl;
        }

        // Function to process dark mode condition
        function processDarkModeCondition(conditions, defaultUrl) {
            const isDarkMode = globalThis.matchMedia && globalThis.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (isDarkMode && conditions.darkModeUrl) {
                document.getElementById('message').textContent = 'Dark mode detected. Redirecting...';
                return conditions.darkModeUrl;
            }
            if (!isDarkMode && conditions.lightModeUrl) {
                document.getElementById('message').textContent = 'Light mode detected. Redirecting...';
                return conditions.lightModeUrl;
            }
            document.getElementById('message').textContent = 'Mode preference not available. Using default. Redirecting...';
            return defaultUrl;
        }

        // Function to determine redirect URL based on condition type
        function getRedirectUrl(conditionType, conditions, defaultUrl) {
            switch (conditionType) {
                case 'time':
                    return processTimeCondition(conditions, defaultUrl);
                case 'location':
                    return processLocationCondition(conditions, defaultUrl);
                case 'language':
                    return processLanguageCondition(conditions, defaultUrl);
                case 'darkMode':
                    return processDarkModeCondition(conditions, defaultUrl);
                default:
                    document.getElementById('message').textContent = 'Unknown condition type. Redirecting to default...';
                    return defaultUrl;
            }
        }

        // Function to show error
        function showError(message) {
            document.getElementById('message').textContent = message;
            document.getElementById('spinner').style.display = 'none';
        }

        // Function to redirect to URL
        function redirectToUrl(redirectUrl) {
            setTimeout(() => {
                if (isValidURL(redirectUrl)) {
                    globalThis.location.href = redirectUrl;
                } else {
                    showError('Error: Invalid redirect URL');
                }
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user prefers dark mode
            if (globalThis.matchMedia && globalThis.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }

            // Get the encoded data from URL parameters
            const urlParams = new URLSearchParams(globalThis.location.search);
            const encodedData = urlParams.get('data');
            
            if (!encodedData) {
                showError('Error: Missing condition data');
                return;
            }
            
            try {
                // Decode the data
                const decodedData = atob(decodeURIComponent(encodedData));
                const [prefix, conditionType, defaultUrl, conditionsJSON] = decodedData.split(':');
                
                // Update icon based on condition type
                if (icons[conditionType]) {
                    document.getElementById('icon').innerHTML = icons[conditionType];
                }
                
                if (prefix !== 'SMART' || !conditionType || !defaultUrl) {
                    throw new Error('Invalid smart QR data format');
                }
                
                const conditions = JSON.parse(conditionsJSON);
                const redirectUrl = getRedirectUrl(conditionType, conditions, defaultUrl);
                redirectToUrl(redirectUrl);
                
            } catch (error) {
                console.error('Error processing smart QR code:', error);
                showError('Error: Could not process the QR code data');
            }
        });
    </script>
</body>
</html>
